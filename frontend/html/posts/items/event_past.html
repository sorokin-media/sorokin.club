{% load posts %}
{% load static %}
{% load text_filters %}
<div class="block feed-post h-entry feed-post-event--past {% css_classes post %}">
    <div class="feed-post-header feed-post-header--event">
        <div class="feed-post-header-icon">
            <div class="post-event-date">
                <div class="post-event-date-day">
                    {{ post.event_datetime|date:"d" }}
                </div>
                <div class="post-event-date-month">
                    {{ post.event_datetime|date:"E"|lower  }}
                </div>
            </div>
        </div>

        <div class="feed-post-header-content">
            <div class="feed-post-header-additiona-info">
                <div class="post-event-location">
                    {% if post.metadata.event.location %}
                        <i class="fas fa-map-marker-alt"></i>&nbsp;{{ post.metadata.event.location | urlize }}
                    {% endif %}
                </div>
                <div class="post-event-title">
                    {{ post.event_datetime|date:"l" }}, в {{ post.event_datetime|date:"H" }}:{{ post.event_datetime|date:"i" }} по {% if post.metadata.event.timezone == "UTC" %}UTC{% else %}Москве{% endif %}
                </div>
            </div>

            <div class="feed-post-title-container">
                <div class="post-event-date">
                    <div class="post-event-date-day">
                        {{ post.event_datetime|date:"d" }}
                    </div>
                    <div class="post-event-date-month">
                        {{ post.event_datetime|date:"E"|lower  }}
                    </div>
                </div>

                <div class="feed-post-title">
                    {% if post.is_pinned %}<i class="fas fa-thumbtack"></i>{% endif %}

                    <span class="p-name">
                        <a href="{% url "show_post" post.type post.slug %}" class="post-title-link">{{ post.title | rutypography }}</a>
                    </span>

                    {% if post.label %}
                        {% include "posts/widgets/label.html" with label=post.label %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="feed-post-author">
        <a href="{% url "profile" post.author.slug %}" class="avatar"><img data-src="{{ post.author.get_avatar }}" alt="Аватар {{ post.author.full_name }}" loading="lazy" /></a>
    </div>

    <div class="feed-post-votes">
        <post-upvote :initial-upvotes="{{ post.upvotes }}"
                     :hours-to-retract-vote="{{settings.RETRACT_VOTE_IN_HOURS}}"
                     upvote-url="{% url "upvote_post" post.slug %}"
                     retract-vote-url="{% url "retract_post_vote" post.slug %}"
                     {% if post.is_voted %}
                        initial-is-voted
                        initial-upvote-timestamp={{post.upvoted_at}}
                     {% endif %}
                     {% if not me|can_upvote:post or upvote_disabled %}is-disabled{% endif %}>
        </post-upvote>
    </div>

    <div class="feed-post-footer">
        <div class="post-event-calendar">
            Добавить в&nbsp;
            <a class="button button-small" href="{% url "generate_ical_invite" %}?title={{ post.title|urlencode }}&date={{ post.event_datetime|date:"c"|urlencode }}&timezone={{ post.metadata.event.timezone|urlencode }}{% if post.metadata.event.location %}&location={{ post.metadata.event.location|urlencode }}{% endif %}&url={{ settings.APP_HOST }}{% url "show_post" post.type post.slug %}" target="_blank"><i class="fab fa-apple"></i>&nbsp;Apple Календарь</a>
            <a class="button button-small" href="{% url "generate_google_invite" %}?title={{ post.title|urlencode }}&date={{ post.event_datetime|date:"c"|urlencode }}&timezone={{ post.metadata.event.timezone|urlencode }}{% if post.metadata.event.location %}&location={{ post.metadata.event.location|urlencode }}{% endif %}&url={{ settings.APP_HOST }}{% url "show_post" post.type post.slug %}" target="_blank"><i class="fab fa-google"></i>&nbsp;Google Календарь</a>
        </div>

        <div class="feed-post-available-icon">
            <span class="post-is-public">
                {% if post.is_public %}
                    <i class="fas fa-globe-americas" title="Публичный ивент"></i>
                {% else %}
                    <i class="fas fa-lock" title="Только для своих"></i>
                {% endif %}
            </span>
        </div>

        {% if post.topic %}
            <span class="feed-post-topic">
                {% include "posts/widgets/topic.html" with topic=post.topic type="inline" %}
            </span>
        {% endif %}

        {% if post.metadata.badges %}
            {% for badge_code, badge in post.metadata.badges.items %}
                <img
                    src="{% static "images/badges" %}/{{ badge_size|default:"small" }}/{{ badge_code }}.png"
                    alt="{{ badge.title }}"
                    class="feed-post-badge">
            {% endfor %}
        {% endif %}

        <a href="{% url "show_post" post.type post.slug %}?comment_order=created_at#comments" class="feed-post-comments">
            {{ post.comment_count }} {{ post.comment_count | rupluralize:"комментарий,комментария,комментариев" }}
        </a>

        {% if post.unread_comments %}
            <a href="{% url "show_post" post.type post.slug %}?comment_order=-created_at#comments" class="feed-post-comments-unread">
                +{{ post.unread_comments }} {{ post.unread_comments | rupluralize:"новый,новых,новых" }}
            </a>
        {% endif %}

        {% include "posts/widgets/bookmark_controls.html" %}

    </div>
</div>
